const first = [
    0x00, 0x13, 0x01, 0x4d,
    0x43, 0x49, 0x51, 0x46, 0x49, 0x46, 0x45, 0x44, 0x4c, 0x48, 0x39, 0x46, 0x34, 0x41, 0x45, 0x43,
    0x58, 0x39, 0x31, 0x36, 0x50, 0x42, 0x44, 0x35, 0x50, 0x33, 0x41, 0x33, 0x30, 0x37, 0x38, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0xa2,
]

const second = [
    0x00, 0x11, 0x01, 0x4d,
    0x43, 0x49, 0x51, 0x46, 0x49, 0x46, 0x45, 0x44, 0x4c, 0x48, 0x39, 0x46, 0x34, 0x41, 0x45, 0x43,
    0x58, 0x39, 0x31, 0x36, 0x50, 0x42, 0x44, 0x35, 0x50, 0x33, 0x41, 0x33, 0x30, 0x37, 0x38, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0xc2,
]

const third = [
    0x00, 0x14, 0x02, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x68,
]

function sendAndConfirm(device, data) {
    return new Promise((resolve, reject) => {
        device.controlTransfer(0x21, 9, 0x0300, 0x0002, data, (e) => {
            console.log("Sent message:" + e);

            device.controlTransfer(0xa1, 1, 0x0300, 0x0002, 64, (e, data) => {
                console.log(e + ":" + JSON.stringify([...data]));

                resolve();
            })
        });
    })
};

function sendData(device, data) {
    return new Promise((resolve, reject) => {
        device.controlTransfer(0x21, 9, 0x0300, 0x0002, data, (e) => {
            console.log("Sent message:" + e);
            resolve();
        });
    })
}


function getData(device) {
    return new Promise((resolve, reject) => {
        device.controlTransfer(0xa1, 1, 0x0300, 0x0002, 64, (e, data) => {
            console.log(e + ":" + JSON.stringify([...data]));
            resolve();
        });
    })
}

async function connect() {
    var usb = require('usb');

    var device = usb.findByIds(0x24f0, 0x2020);

    device.open();

    await sendAndConfirm(device, Buffer(first));
    await sendAndConfirm(device, Buffer(second));
    await getData(device);
    await getData(device);
    await sendData(device, Buffer(third));
}

connect();
